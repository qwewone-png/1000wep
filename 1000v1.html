<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì²œìë¬¸ ì‘ì„±ê¸° (ì‹­ì´ê°„ì§€ ë¬¸ì„œ ì„ íƒ)</title>
<style>
  :root {
      /* Light Mode (í•´â˜€ï¸) colors - ë°ê³  ì¾Œì²­í•œ ë‚® */
      --body-bg: #fafafa;
      --text-color: #333;
      --header-bg: #4a90e2;
      --header-text-color: white;
      --table-bg: white;
      --table-border: #bbb;
      --button-bg: #4a90e2;
      --button-hover-bg: #357abd;
      --delete-button-bg: #d9534f;
      --delete-button-hover-bg: #c9302c;
      --select-border: #ccc;
      --focus-outline: #4a90e2;
      --duplicate-color: red;
      --scroll-button-bg: rgba(74, 144, 226, 0.8);
      --scroll-button-hover-bg: #4a90e2;
      --modal-bg: rgba(0, 0, 0, 0.5);
      --modal-content-bg: white;
      --modal-content-border: #ddd;
  }
  body.slight-dark-mode {
      /* Slight Dark Mode (í•´êµ¬ë¦„â›…) colors - ì˜…ì€ êµ¬ë¦„ì´ ë‚€ ë‚®, ëˆˆì— í¸ì•ˆí•¨ */
      --body-bg: #e0e0e0;
      --text-color: #333;
      --header-bg: #4a90e2;
      --header-text-color: white;
      --table-bg: #f5f5f5;
      --table-border: #aaa;
      --button-bg: #4a90e2;
      --button-hover-bg: #357abd;
      --delete-button-bg: #d9534f;
      --delete-button-hover-bg: #c9302c;
      --select-border: #bbb;
      --focus-outline: #4a90e2;
      --duplicate-color: red;
      --scroll-button-bg: rgba(74, 144, 226, 0.8);
      --scroll-button-hover-bg: #4a90e2;
      --modal-bg: rgba(0, 0, 0, 0.5);
      --modal-content-bg: #f5f5f5;
      --modal-content-border: #ccc;
  }
  body.cloud-mode {
      /* Cloud Mode (êµ¬ë¦„â˜ï¸) colors - íë¦° ë‚ ì”¨, ì°¨ë¶„í•œ ì´ˆì €ë… */
      --body-bg: #3d3d3d;
      --text-color: #f0f0f0;
      --header-bg: #2d5d8b;
      --header-text-color: #f0f0f0;
      --table-bg: #4a4a4a;
      --table-border: #666;
      --button-bg: #666;
      --button-hover-bg: #777;
      --delete-button-bg: #d9534f;
      --delete-button-hover-bg: #c9302c;
      --select-border: #666;
      --focus-outline: #81c3e0;
      --duplicate-color: #ff8c8c;
      --scroll-button-bg: rgba(74, 144, 226, 0.8);
      --scroll-button-hover-bg: #4a90e2;
      --modal-bg: rgba(0, 0, 0, 0.7);
      --modal-content-bg: #4a4a4a;
      --modal-content-border: #666;
  }
  body.moon-mode {
      /* Moon Mode (ë³´ë¦„ë‹¬ğŸŒ•) colors - ë‹¬ì´ ëœ¬ ë°¤, ì–´ë‘ìš´ ë°°ê²½ */
      --body-bg: #222;
      --text-color: #e0e0e0;
      --header-bg: #2d5d8b;
      --header-text-color: #e0e0e0;
      --table-bg: #333;
      --table-border: #555;
      --button-bg: #555;
      --button-hover-bg: #666;
      --delete-button-bg: #a94442;
      --delete-button-hover-bg: #8c3b39;
      --select-border: #555;
      --focus-outline: #81c3e0;
      --duplicate-color: #ff6b6b;
      --scroll-button-bg: rgba(74, 144, 226, 0.8);
      --scroll-button-hover-bg: #4a90e2;
      --modal-bg: rgba(0, 0, 0, 0.7);
      --modal-content-bg: #333;
      --modal-content-border: #555;
  }
  body.dark-mode {
      /* Dark Mode (ì´ˆìŠ¹ë‹¬ğŸŒ™) colors - ê°€ì¥ ì–´ë‘ìš´ ì‹¬ì•¼, ëˆˆì˜ í”¼ë¡œ ìµœì†Œí™” */
      --body-bg: #121212;
      --text-color: #e0e0e0;
      --header-bg: #333;
      --header-text-color: #e0e0e0;
      --table-bg: #222;
      --table-border: #444;
      --button-bg: #555;
      --button-hover-bg: #666;
      --delete-button-bg: #a94442;
      --delete-button-hover-bg: #8c3b39;
      --select-border: #555;
      --focus-outline: #81c3e0;
      --duplicate-color: #ff6b6b;
      --scroll-button-bg: rgba(74, 144, 226, 0.8);
      --scroll-button-hover-bg: #4a90e2;
      --modal-bg: rgba(0, 0, 0, 0.7);
      --modal-content-bg: #333;
      --modal-content-border: #555;
  }
  body {
    font-family: "Noto Sans KR", sans-serif;
    margin: 20px;
    background: var(--body-bg);
    color: var(--text-color);
    transition: background-color 0.3s, color 0.3s;
  }
  #docControls {
    margin-bottom: 20px;
    display: flex;
    justify-content: flex-start;
    align-items: center;
  }
  #docControls label, #docControls select, #docControls button {
    vertical-align: middle;
    font-size: 15px;
  }
  #docControls select {
    width: 260px;
    padding: 6px 8px;
    margin-right: 10px;
    border: 1px solid var(--select-border);
    border-radius: 4px;
    background: var(--table-bg);
    color: var(--text-color);
  }
  #docControls .left-controls {
      display: flex;
      align-items: center;
  }
  #docControls button.action-button {
    padding: 6px 14px;
    border-radius: 4px;
    border: none;
    background-color: var(--button-bg);
    color: var(--header-text-color);
    cursor: pointer;
    margin-right: 8px;
  }
  #docControls button.action-button:hover {
    background-color: var(--button-hover-bg);
  }
  #themeToggleBtn {
      font-size: 24px;
      line-height: 1;
      font-weight: bold;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
    background: var(--table-bg);
    box-shadow: 0 0 5px rgba(0,0,0,0.1);
  }
  th, td {
    border: 1px solid var(--table-border);
    padding: 8px;
    text-align: center;
    vertical-align: middle;
    word-break: break-word;
  }
  th {
    background-color: var(--header-bg);
    color: var(--header-text-color);
    user-select: none;
  }
  td.hanja-cell {
    font-size: 22px;
    cursor: text;
    user-select: text;
    min-height: 28px;
    padding: 6px;
  }
  td.hanja-cell span.duplicate {
    color: var(--duplicate-color);
    font-weight: 700;
  }
  .reading-editable, .desc-editable, .hanja-editable {
    width: 100%;
    border: none;
    padding: 6px;
    box-sizing: border-box;
    min-height: 28px;
    outline: none;
    cursor: text;
    white-space: pre-wrap;
    text-align: left;
    color: var(--text-color);
    background: transparent;
  }
  .reading-editable {
    font-size: 22px;
    text-align: center;
  }
  .desc-editable {
    font-size: 16px;
  }
  .hanja-editable {
    font-size: 22px;
    text-align: center;
  }
  .active-cell {
    box-shadow: 0 0 0 2px var(--focus-outline);
    border-color: var(--focus-outline);
  }
  button.row-delete-btn {
    background-color: var(--delete-button-bg);
    border: none;
    color: white;
    font-weight: bold;
    cursor: pointer;
    border-radius: 4px;
    padding: 5px 10px;
  }
  button.row-delete-btn:hover {
    background-color: var(--delete-button-hover-bg);
  }
  .row-number {
    font-size: 14px;
    font-weight: bold;
    color: #666;
  }
  body.dark-mode .row-number, body.moon-mode .row-number, body.cloud-mode .row-number {
    color: #aaa;
  }
  body.slight-dark-mode .row-number {
      color: #666;
  }
  .scroll-buttons {
    position: fixed;
    right: 20px;
    bottom: 20px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    z-index: 100;
  }
  .scroll-buttons button {
    background-color: var(--scroll-button-bg);
    color: white;
    border: none;
    border-radius: 5px;
    padding: 8px;
    cursor: pointer;
    opacity: 0.7;
    transition: opacity 0.3s ease;
  }
  .scroll-buttons button:hover {
    opacity: 1;
  }
  .scroll-buttons button svg {
    width: 24px;
    height: 24px;
    display: block;
  }
  /* Modal styles */
  .modal {
      display: none;
      position: fixed;
      z-index: 200;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: var(--modal-bg);
  }
  .modal-content {
      background-color: var(--modal-content-bg);
      color: var(--text-color);
      padding: 20px;
      border: 1px solid var(--modal-content-border);
      width: 80%;
      max-width: 600px;
      border-radius: 8px;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
  }
  .close-button {
      color: var(--text-color);
      float: right;
      font-size: 28px;
      font-weight: bold;
      position: absolute;
      top: 10px;
      right: 20px;
  }
  .close-button:hover,
  .close-button:focus {
      color: var(--delete-button-bg);
      text-decoration: none;
      cursor: pointer;
  }
  .modal-content h3 {
      border-bottom: 2px solid var(--table-border);
      padding-bottom: 5px;
  }
  .modal-content ul {
      list-style-type: disc;
      padding-left: 20px;
  }
  .modal-content li {
      margin-bottom: 10px;
      line-height: 1.5;
  }
</style>
</head>
<body>

<div id="docControls">
  <div class="left-controls">
    <label for="docSelect">ë¬¸ì„œ ì„ íƒ:</label>
    <select id="docSelect">
      <option value="doc_ì">ì(å­)</option>
      <option value="doc_ì¶•">ì¶•(ä¸‘)</option>
      <option value="doc_ì¸">ì¸(å¯…)</option>
      <option value="doc_ë¬˜">ë¬˜(å¯)</option>
      <option value="doc_ì§„">ì§„(è¾°)</option>
      <option value="doc_ì‚¬">ì‚¬(å·³)</option>
      <option value="doc_ì˜¤">ì˜¤(åˆ)</option>
      <option value="doc_ë¯¸">ë¯¸(æœª)</option>
      <option value="doc_ì‹ ">ì‹ (ç”³)</option>
      <option value="doc_ìœ ">ìœ (é…‰)</option>
      <option value="doc_ìˆ ">ìˆ (æˆŒ)</option>
      <option value="doc_í•´">í•´(äº¥)</option>
    </select>
    <button id="btnLoad" class="action-button">ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <button id="btnExport" class="action-button">ë‚´ë³´ë‚´ê¸°</button>
    <button id="btnInfo" class="action-button">ì„¤ëª…</button>
  </div>
</div>

<table id="tableCheonjamun" cellspacing="0" cellpadding="0">
  <thead>
    <tr>
      <th style="width:3%;">ìˆœë²ˆ</th>
      <th style="width:18%;">í•œì</th>
      <th style="width:18%;">ìŒí›ˆ</th>
      <th style="width:auto;">í•´ì„¤</th>
      <th style="width:8%;">ì¤„ ì‚­ì œ</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>

<div class="scroll-buttons">
  <button id="themeToggleBtn" title="í…Œë§ˆ ì „í™˜">â˜€ï¸</button>
  <button id="scrollTopBtn" title="ë§¨ ìœ„ë¡œ"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/></svg></button>
  <button id="scrollBottomBtn" title="ë§¨ ì•„ë˜ë¡œ"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6z"/></svg></button>
</div>

<div id="infoModal" class="modal">
  <div class="modal-content">
    <span class="close-button">&times;</span>
    <h2>ì‚¬ìš© ë°©ë²• ì•ˆë‚´</h2>
    <p>ì´ ì›¹ ë„êµ¬ëŠ” ì²œìë¬¸ì„ ì‘ì„±í•˜ê³  ê´€ë¦¬í•˜ëŠ” ë° ë„ì›€ì„ ì¤ë‹ˆë‹¤.</p>
    
    <h3>ë¬¸ì„œ ì„ íƒ ë° ë¶ˆëŸ¬ì˜¤ê¸°</h3>
    <ul>
      <li>ì²˜ìŒ í˜ì´ì§€ë¥¼ ì—´ë©´ ë§ˆì§€ë§‰ìœ¼ë¡œ ì‘ì—…í–ˆë˜ ë¬¸ì„œê°€ ìë™ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤.</li>
      <li>ë‹¤ë¥¸ ë¬¸ì„œë¥¼ ë¶ˆëŸ¬ì˜¤ë ¤ë©´, ë“œë¡­ë‹¤ìš´ ë©”ë‰´ì—ì„œ ì›í•˜ëŠ” **ë¬¸ì„œë¥¼ ì„ íƒ**í•œ í›„ **[ë¶ˆëŸ¬ì˜¤ê¸°]** ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</li>
      <li>ë¬¸ì„œê°€ ì—†ì„ ê²½ìš° ìƒˆ ë¬¸ì„œë¥¼ ë§Œë“¤ì§€ ë¬»ëŠ” ì°½ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</li>
    </ul>

    <h3>ì‘ì„± ë° ìˆ˜ì •</h3>
    <ul>
      <li>í…Œì´ë¸”ì˜ ê° ì¹¸ì„ í´ë¦­í•˜ì—¬ ë‚´ìš©ì„ ì…ë ¥í•˜ê±°ë‚˜ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li>í•œì ì¹¸ì— 4ê¸€ìë¥¼ ì…ë ¥í•˜ê³  **Enter**ë¥¼ ëˆ„ë¥´ê±°ë‚˜, ë‹¤ë¥¸ ê³³ì„ **ë§ˆìš°ìŠ¤ë¡œ í´ë¦­**í•˜ë©´ ìë™ìœ¼ë¡œ ìƒˆ ì¤„ì´ ì¶”ê°€ë©ë‹ˆë‹¤.</li>
    </ul>
    
    <h3>ì¤‘ë³µ í•œì í™•ì¸</h3>
    <ul>
      <li>ì‘ì„±ëœ í•œìë“¤ ì¤‘ì— **ì¤‘ë³µëœ í•œì**ëŠ” ìë™ìœ¼ë¡œ **ë¶‰ì€ìƒ‰**ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</li>
      <li>ì¤‘ë³µ ì²´í¬ëŠ” í•œì ì¹¸ì˜ ë‚´ìš©ì„ ìˆ˜ì •í•˜ê±°ë‚˜ ìƒˆ ì¤„ì„ ì¶”ê°€í•  ë•Œë§ˆë‹¤ ìë™ìœ¼ë¡œ ì´ë£¨ì–´ì§‘ë‹ˆë‹¤.</li>
    </ul>
    
    <h3>ê¸°íƒ€ ê¸°ëŠ¥</h3>
    <ul>
      <li>ì˜¤ë¥¸ìª½ ì•„ë˜ì˜ **í…Œë§ˆ ì „í™˜ ë²„íŠ¼**ì„ ëˆŒëŸ¬ ì´ 5ë‹¨ê³„ì˜ í…Œë§ˆë¥¼ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        <br>â˜€ï¸ (ë°ì€ ë‚®) â†’ â›… (íë¦° ë‚®) â†’ â˜ï¸ (ì´ˆì €ë…) â†’ ğŸŒ• (ë°¤) â†’ ğŸŒ™ (ì‹¬ì•¼)
      </li>
      <li>ê° ì¤„ì˜ **[ì§€ìš°ê¸°]** ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ í•´ë‹¹ ì¤„ì´ ì‚­ì œë©ë‹ˆë‹¤.</li>
      <li>ì˜¤ë¥¸ìª½ ì•„ë˜ì˜ **ìŠ¤í¬ë¡¤ ë²„íŠ¼**ì„ ì´ìš©í•´ í˜ì´ì§€ ë§¨ ìœ„/ì•„ë˜ë¡œ ë¹ ë¥´ê²Œ ì´ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li>**[ë‚´ë³´ë‚´ê¸°]** ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ í˜„ì¬ ë¬¸ì„œì˜ ë‚´ìš©ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì–´ ì—‘ì…€ ë“±ì— ë¶™ì—¬ë„£ê¸° í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li>ë°ì´í„° ì €ì¥: ë¬¸ì„œ ë‚´ìš©ì€ ì‚¬ìš©ìì˜ ì»´í“¨í„° ë¸Œë¼ìš°ì €ì— ì €ì¥ë©ë‹ˆë‹¤. ì»´í“¨í„°ë¥¼ í¬ë§·í•˜ê±°ë‚˜ ë¸Œë¼ìš°ì € ìºì‹œë¥¼ ì‚­ì œí•˜ì§€ ì•ŠëŠ” í•œ ë°ì´í„°ê°€ ìœ ì§€ë©ë‹ˆë‹¤. ì¤‘ìš”í•œ ìë£ŒëŠ” **[ë‚´ë³´ë‚´ê¸°]** ê¸°ëŠ¥ì„ ì´ìš©í•´ ì •ê¸°ì ìœ¼ë¡œ ë°±ì—…í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.</li>
    </ul>
  </div>
</div>

<script>
(() => {
  const tbody = document.querySelector('#tableCheonjamun tbody');
  const docSelect = document.getElementById('docSelect');
  const btnLoad = document.getElementById('btnLoad');
  const btnExport = document.getElementById('btnExport');
  const btnInfo = document.getElementById('btnInfo');
  const infoModal = document.getElementById('infoModal');
  const closeButton = infoModal.querySelector('.close-button');
  const scrollTopBtn = document.getElementById('scrollTopBtn');
  const scrollBottomBtn = document.getElementById('scrollBottomBtn');
  const themeToggleBtn = document.getElementById('themeToggleBtn');
  
  // í…Œë§ˆ ìƒíƒœ ë° ì„¤ì •
  const themes = [
    { name: 'light', icon: 'â˜€ï¸', class: '' },
    { name: 'slight-dark', icon: 'â›…', class: 'slight-dark-mode' },
    { name: 'cloud', icon: 'â˜ï¸', class: 'cloud-mode' },
    { name: 'moon', icon: 'ğŸŒ•', class: 'moon-mode' },
    { name: 'dark', icon: 'ğŸŒ™', class: 'dark-mode' }
  ];

  function applyTheme(themeName) {
    const theme = themes.find(t => t.name === themeName);
    document.body.className = '';
    if (theme.class) {
      document.body.classList.add(theme.class);
    }
    themeToggleBtn.textContent = theme.icon;
    themeToggleBtn.title = `í…Œë§ˆ ì „í™˜: ${theme.name} ëª¨ë“œ`;
    localStorage.setItem('theme', theme.name);
  }

  // ì´ˆê¸° í…Œë§ˆ ë¡œë“œ
  const savedTheme = localStorage.getItem('theme') || 'light';
  applyTheme(savedTheme);

  // Theme toggle button click event
  themeToggleBtn.addEventListener('click', () => {
    const currentTheme = localStorage.getItem('theme') || 'light';
    const currentIndex = themes.findIndex(t => t.name === currentTheme);
    const nextIndex = (currentIndex + 1) % themes.length;
    applyTheme(themes[nextIndex].name);
  });

  // ì¤‘ë³µ í•œì ì²´í¬ & ë¹¨ê°„ìƒ‰ í‘œì‹œ
  function highlightDuplicates() {
    const counts = {};
    const editableDivs = [...tbody.querySelectorAll('div.hanja-editable')];
    
    const rowsToCount = editableDivs.slice(0, -1);

    rowsToCount.forEach(div => {
      const text = div.textContent.trim();
      for (const ch of text) {
        if(ch !== '') {
          counts[ch] = (counts[ch] || 0) + 1;
        }
      }
    });

    editableDivs.forEach(div => {
      const text = div.textContent.trim();
      div.innerHTML = '';
      for (const ch of text) {
        const span = document.createElement('span');
        span.textContent = ch;
        if(counts[ch] > 1) {
          span.classList.add('duplicate');
        }
        div.appendChild(span);
      }
      if(text.length === 0) div.innerHTML = '<br>';
    });
  }

  // ìˆœë²ˆ ì—…ë°ì´íŠ¸
  function updateRowNumbers() {
      const rows = tbody.querySelectorAll('tr:not(.blank-row)');
      rows.forEach((row, index) => {
          let numberCell = row.querySelector('.row-number');
          if (!numberCell) {
              const td = document.createElement('td');
              td.classList.add('row-number');
              row.prepend(td);
              numberCell = td;
          }
          numberCell.textContent = index + 1;
      });
  }
  
  // ìƒˆë¡œìš´ í–‰ ì¶”ê°€ (ë¹ˆ ì¤„ ì œì™¸)
  function addRow(hanja='', reading='', desc='') {
    const tr = document.createElement('tr');

    const tdNumber = document.createElement('td');
    tdNumber.classList.add('row-number');
    tdNumber.textContent = '';
    
    const tdHanja = document.createElement('td');
    tdHanja.classList.add('hanja-cell');
    const hanjaDiv = document.createElement('div');
    hanjaDiv.classList.add('hanja-editable');
    hanjaDiv.contentEditable = 'true';
    hanjaDiv.spellcheck = false;
    hanjaDiv.textContent = hanja;
    tdHanja.appendChild(hanjaDiv);
    
    const tdReading = document.createElement('td');
    const readingDiv = document.createElement('div');
    readingDiv.classList.add('reading-editable');
    readingDiv.contentEditable = 'true';
    readingDiv.spellcheck = false;
    readingDiv.textContent = reading;
    tdReading.appendChild(readingDiv);
    
    const tdDesc = document.createElement('td');
    const descDiv = document.createElement('div');
    descDiv.classList.add('desc-editable');
    descDiv.contentEditable = 'true';
    descDiv.spellcheck = false;
    descDiv.textContent = desc;
    tdDesc.appendChild(descDiv);
    
    const tdDel = document.createElement('td');
    const btnDel = document.createElement('button');
    btnDel.textContent = 'ì§€ìš°ê¸°';
    btnDel.classList.add('row-delete-btn');
    tdDel.appendChild(btnDel);

    tr.appendChild(tdNumber);
    tr.appendChild(tdHanja);
    tr.appendChild(tdReading);
    tr.appendChild(tdDesc);
    tr.appendChild(tdDel);

    tbody.appendChild(tr);
  }

  // ë¹ˆ ì…ë ¥ ì¤„ ìƒì„±
  function addBlankRow() {
    const tr = document.createElement('tr');
    tr.classList.add('blank-row');

    const tdNumber = document.createElement('td');
    tdNumber.classList.add('row-number');
    
    const tdHanja = document.createElement('td');
    tdHanja.classList.add('hanja-cell');
    const hanjaDiv = document.createElement('div');
    hanjaDiv.classList.add('hanja-editable');
    hanjaDiv.contentEditable = 'true';
    hanjaDiv.spellcheck = false;
    tdHanja.appendChild(hanjaDiv);
    
    const tdReading = document.createElement('td');
    const readingDiv = document.createElement('div');
    readingDiv.classList.add('reading-editable');
    readingDiv.contentEditable = 'true';
    readingDiv.spellcheck = false;
    tdReading.appendChild(readingDiv);
    
    const tdDesc = document.createElement('td');
    const descDiv = document.createElement('div');
    descDiv.classList.add('desc-editable');
    descDiv.contentEditable = 'true';
    descDiv.spellcheck = false;
    tdDesc.appendChild(descDiv);
    
    const tdDel = document.createElement('td');
    
    tr.appendChild(tdNumber);
    tr.appendChild(tdHanja);
    tr.appendChild(tdReading);
    tr.appendChild(tdDesc);
    tr.appendChild(tdDel);

    tbody.appendChild(tr);
    hanjaDiv.focus();
  }

  // í…Œì´ë¸” ë°ì´í„° ê°ì²´ë¡œ ì¶”ì¶œ
  function getData() {
    const data = [];
    const rows = [...tbody.children].slice(0, -1);
    rows.forEach(tr => {
      const hanjaDiv = tr.querySelector('div.hanja-editable');
      const readingDiv = tr.querySelector('div.reading-editable');
      const descDiv = tr.querySelector('div.desc-editable');
      data.push({
        hanja: hanjaDiv.textContent.trim(),
        reading: readingDiv.textContent.trim(),
        desc: descDiv.textContent.trim()
      });
    });
    return data;
  }

  // ë°ì´í„°ë¡œ í…Œì´ë¸” ì´ˆê¸°í™”
  function setData(data) {
    tbody.innerHTML = '';
    data.forEach(row => {
      addRow(row.hanja || '', row.reading || '', row.desc || '');
    });
    addBlankRow();
    highlightDuplicates();
    updateRowNumbers();
    updateDocSelectOptions();
  }

  // ì €ì¥ - ìë™ ì €ì¥ í•¨ìˆ˜
  function autoSave() {
    const key = docSelect.value;
    const data = getData();
    localStorage.setItem(key, JSON.stringify(data));
    updateDocSelectOptions();
  }
  
  // ë“œë¡­ë‹¤ìš´ ë©”ë‰´ì˜ ì¤„ ìˆ˜ í‘œì‹œ ì—…ë°ì´íŠ¸
  function updateDocSelectOptions() {
      const options = docSelect.options;
      for (let i = 0; i < options.length; i++) {
          const option = options[i];
          const key = option.value;
          const dataStr = localStorage.getItem(key);
          let count = 0;
          if (dataStr) {
              try {
                  const data = JSON.parse(dataStr);
                  count = data.length;
              } catch(e) {
                  count = 0;
              }
          }
          const originalText = option.getAttribute('data-original-text') || option.text.split(' - ')[0];
          option.setAttribute('data-original-text', originalText);
          
          if (count === 0) {
              option.text = `${originalText} - ë¬¸ì„œ ì—†ìŒ`;
          } else {
              option.text = `${originalText} - ì´ ${count}ì¤„ ê¸°ë¡`;
          }
      }
  }

  // ë¬¸ì„œ ë¶ˆëŸ¬ì˜¤ê¸° (ë²„íŠ¼ í´ë¦­ ì‹œ)
  function loadDoc() {
      const key = docSelect.value;
      const dataStr = localStorage.getItem(key);
      if(!dataStr) {
          if(confirm(`${docSelect.options[docSelect.selectedIndex].getAttribute('data-original-text')} ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆ ë¬¸ì„œë¥¼ ë§Œë“œì‹œê² ìŠµë‹ˆê¹Œ?`)) {
              setData([]);
              localStorage.setItem(key, JSON.stringify([])); // ë¹ˆ ë¬¸ì„œ ì €ì¥
              alert(`${docSelect.options[docSelect.selectedIndex].getAttribute('data-original-text')} ë¬¸ì„œë¥¼ ìƒˆë¡œ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.`);
          }
      } else {
          try {
              const data = JSON.parse(dataStr);
              setData(data);
              alert(`${docSelect.options[docSelect.selectedIndex].getAttribute('data-original-text')} ë¬¸ì„œë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
          } catch(e) {
              alert('ë¬¸ì„œ ë¶ˆëŸ¬ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
              setData([]);
              localStorage.setItem(key, JSON.stringify([])); // ì˜¤ë¥˜ ì‹œ ë¹ˆ ë¬¸ì„œë¡œ ì´ˆê¸°í™”
          }
      }
      localStorage.setItem('lastActiveDocId', key); // ë¶ˆëŸ¬ì˜¨ ë¬¸ì„œë¥¼ ë§ˆì§€ë§‰ìœ¼ë¡œ í¸ì§‘í•œ ë¬¸ì„œë¡œ ì„¤ì •
  }
  
  // ë¬¸ì„œ ë¶ˆëŸ¬ì˜¤ê¸° (ì´ˆê¸° ë¡œë“œìš©, ì•Œë¦¼ ì—†ìŒ)
  function initialLoadDoc() {
      const lastActiveDocId = localStorage.getItem('lastActiveDocId') || 'doc_ì';
      docSelect.value = lastActiveDocId;
      const dataStr = localStorage.getItem(lastActiveDocId);
      if (dataStr) {
          try {
              const data = JSON.parse(dataStr);
              setData(data);
          } catch(e) {
              setData([]);
          }
      } else {
          setData([]);
      }
      updateDocSelectOptions();
  }

  // 'ë‚´ë³´ë‚´ê¸°' ê¸°ëŠ¥ ì¶”ê°€
  function exportTableToClipboard() {
      const tableRows = tbody.querySelectorAll('tr:not(.blank-row)');
      let exportText = 'ìˆœë²ˆ\tí•œì\tìŒí›ˆ\tí•´ì„¤\n'; // í—¤ë” ì¶”ê°€

      tableRows.forEach(row => {
          const rowNumber = row.querySelector('.row-number').textContent;
          const hanja = row.querySelector('.hanja-editable').textContent.trim();
          const reading = row.querySelector('.reading-editable').textContent.trim();
          const desc = row.querySelector('.desc-editable').textContent.trim();
          
          exportText += `${rowNumber}\t${hanja}\t${reading}\t${desc}\n`;
      });
      
      navigator.clipboard.writeText(exportText)
          .then(() => {
              alert('í‘œ ë‚´ìš©ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
          })
          .catch(err => {
              console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
              alert('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          });
  }

  // ì´ë²¤íŠ¸ ì—°ê²°
  btnLoad.addEventListener('click', loadDoc);
  btnExport.addEventListener('click', exportTableToClipboard); // 'ë‚´ë³´ë‚´ê¸°' ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°

  docSelect.addEventListener('change', () => {
    // ë¬¸ì„œ ì„ íƒ ë“œë¡­ë‹¤ìš´ì´ ë³€ê²½ë  ë•Œ, ë§ˆì§€ë§‰ìœ¼ë¡œ ì„ íƒëœ ë¬¸ì„œë¥¼ ì €ì¥ë§Œ í•˜ê³  í™”ë©´ì„ ë¹„ìš°ì§€ ì•ŠìŒ
    localStorage.setItem('lastActiveDocId', docSelect.value);
  });

  tbody.addEventListener('click', e => {
    if(e.target.classList.contains('row-delete-btn')) {
      e.target.closest('tr').remove();
      highlightDuplicates();
      autoSave();
      updateRowNumbers();
    }
  });

  // ìˆ˜ì • ì™„ë£Œ ì‹œ ì¤‘ë³µ ì²´í¬ ë° ì €ì¥
  tbody.addEventListener('blur', e => {
    const row = e.target.closest('tr');
    if (!row) return;

    const hanjaDiv = e.target.closest('div.hanja-editable');
    const currentRow = e.target.closest('tr');
    const blankRow = tbody.querySelector('.blank-row');

    // ë¹ˆ ì¤„ì˜ í•œì ì…ë ¥ ì¹¸ì—ì„œ í¬ì»¤ìŠ¤ë¥¼ ìƒê³ , 4ê¸€ìê°€ ì…ë ¥ë˜ì—ˆì„ ë•Œ
    if (currentRow === blankRow && hanjaDiv && hanjaDiv.textContent.trim().length === 4) {
        currentRow.classList.remove('blank-row');
        
        const deleteButtonCell = currentRow.querySelector('td:last-child');
        let btnDel = deleteButtonCell.querySelector('.row-delete-btn');
        if (!btnDel) {
            btnDel = document.createElement('button');
            btnDel.textContent = 'ì§€ìš°ê¸°';
            btnDel.classList.add('row-delete-btn');
            deleteButtonCell.appendChild(btnDel);
        }

        addBlankRow();
        highlightDuplicates();
        autoSave();
        updateRowNumbers();

        const readingDivInSameRow = currentRow.querySelector('div.reading-editable');
        if (readingDivInSameRow) {
            readingDivInSameRow.focus();
        }
    } else {
        // ê¸°ì¡´ í–‰ì˜ ê²½ìš°, ê·¸ëƒ¥ ì €ì¥í•˜ê³  ì¤‘ë³µ ì²´í¬
        if (!currentRow.classList.contains('blank-row')) {
            highlightDuplicates();
            autoSave();
        }
    }
  }, true);

  // í™œì„± ì…€ ê°•ì¡° íš¨ê³¼
  tbody.addEventListener('focusin', e => {
      const currentActiveCell = tbody.querySelector('.active-cell');
      if (currentActiveCell) {
          currentActiveCell.classList.remove('active-cell');
      }
      const targetDiv = e.target.closest('div[contenteditable="true"]');
      if (targetDiv) {
          targetDiv.classList.add('active-cell');
      }
  });

  tbody.addEventListener('keydown', e => {
    if (e.key === 'Enter' && e.target.closest('div[contenteditable="true"]')) {
      e.preventDefault();
      
      const targetElement = e.target;
      const currentRow = targetElement.closest('tr');
      const nextRow = currentRow.nextElementSibling;
      const blankRow = tbody.querySelector('.blank-row');
      
      const hanjaDiv = targetElement.closest('div.hanja-editable');
      const readingDiv = targetElement.closest('div.reading-editable');
      const descDiv = targetElement.closest('div.desc-editable');

      if (currentRow === blankRow) {
          if (hanjaDiv && hanjaDiv.textContent.trim().length === 4) {
              
              currentRow.classList.remove('blank-row');
              
              const deleteButtonCell = currentRow.querySelector('td:last-child');
              let btnDel = deleteButtonCell.querySelector('.row-delete-btn');
              if (!btnDel) {
                  btnDel = document.createElement('button');
                  btnDel.textContent = 'ì§€ìš°ê¸°';
                  btnDel.classList.add('row-delete-btn');
                  deleteButtonCell.appendChild(btnDel);
              }

              addBlankRow();
              highlightDuplicates();
              autoSave();
              updateRowNumbers();
              
              const readingDivInSameRow = currentRow.querySelector('div.reading-editable');
              if (readingDivInSameRow) {
                  readingDivInSameRow.focus();
              }
          } else {
              alert('í•œì 4ê¸€ìë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          }
      } else { // ê¸°ì¡´ í–‰ì—ì„œ ì—”í„° í‚¤ë¥¼ ëˆŒë €ì„ ë•Œ
          if (hanjaDiv) {
              const readingDivInSameRow = currentRow.querySelector('div.reading-editable');
              if (readingDivInSameRow) {
                  readingDivInSameRow.focus();
              }
          } else if (readingDiv) {
              const descDivInSameRow = currentRow.querySelector('div.desc-editable');
              if (descDivInSameRow) {
                  descDivInSameRow.focus();
              }
          } else if (descDiv) {
              if (nextRow) {
                  nextRow.querySelector('div.hanja-editable').focus();
              } else {
                  if(blankRow) {
                      blankRow.querySelector('div.hanja-editable').focus();
                  }
              }
          }
      }
    }
  });

  // ìŠ¤í¬ë¡¤ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
  scrollTopBtn.addEventListener('click', () => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  scrollBottomBtn.addEventListener('click', () => {
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
  });

  // Info modal event listeners
  btnInfo.addEventListener('click', () => {
      infoModal.style.display = 'block';
  });
  closeButton.addEventListener('click', () => {
      infoModal.style.display = 'none';
  });
  window.addEventListener('click', (event) => {
      if (event.target === infoModal) {
          infoModal.style.display = 'none';
      }
  });

  // ì´ˆê¸° ë¡œë“œ ì‹œ ì²« ë¬¸ì„œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹œë„
  window.addEventListener('load', () => {
    initialLoadDoc();
  });
})();
</script>

</body>
</html>
